<!DOCTYPE html>
<html>
	<head>
		<title>F22 213 ERP Experiment</title>
		<script src="JSPsych/jspsych@7.3.0"></script>
		<script src="JSPsych/plugin-html-keyboard-response@1.1.2"></script>
	    <script src="JSPsych/plugin-survey-text@1.1.0"></script>
		<script src="erp-sentence/index.js"></script>
		<link href="JSPsych/jspsych.css" rel="stylesheet" type="text/css" />
	</head>
	<body></body>
	<script>
/*		var test = [
			["The dogs are ", "barking", "bark"],
			["My dog doesn't ", "bark", "barking"],

			["Little children should ", "play", "playing"],
			["Your brother is ", "playing", "play"],

			["Fred dropped two ", "books", "book"],
			["She took a ", "book", "books"],

			["I purchased three ", "tickets", "ticket"],
			["There remained one ", "ticket", "tickets"],

			["Don't forget to ", "smile", "smiling"],
			["The boys were ", "smiling", "smile"],

			["Herbert listened while ", "running", "ran"],
			["Sputtering, the engine ", "ran", "running"],

			["Bakeries don't sell ", "vehicles", "vehicle"],
			["That's an electric ", "vehicle", "vehicles"],

			["There's an energy ", "shortage", "shortages"],
			["Bookkeepers noticed supply ", "shortages", "shortage"],

			["The miscreants had ", "loitered", "loitering"],
			["This hotel forbade ", "loitering", "loitered"],

			["They all brought ", "pencils", "pencil"],
			["Sue borrowed a ", "pencil", "pencils"],

			["My wife will ", "complain", "complains"]
			["Jeffery's milkman never ", "complains", "complain"],

			["Bipeds have two ", "legs", "leg"],
			["I'll examine that ", "leg", "legs"],

			["The burglar tiptoed ", "quietly", "quiet"],
			["Cities are rarely ", "quiet", "quietly"],

			["Dan ordered a ", "beer", "beers"],
			["He downed four ", "beers", "beer"],

			["It failed to ", "explode", "exploding"],
			["Our sales are ", "exploding", "explode"],

			["Nonconformists seemingly cannot ", "compromise", "compromised"],
			["The swindler reluctantly ", "compromised", "compromise"],

			["Online, reviews were ", "terrible", "terribly"],
			["Ultimately, it aged ", "terribly", "terrible"],

			["Organ donors must ", "volunteer", "volunteering"],
			["Richard went out ", "volunteering", "volunteer"],

			["The sprawl stretched ", "miles", "mile"],
			["Beth ran a ", "mile", "miles"],

			["Kimberly detected an ", "imbalance", "imbalanced"],
			["Your messaging is ", "imbalanced", "imbalance"],

			["Persuasive communication can ", "unite", "united"],
			["The people were ", "united", "unite"],

			["Bazaars have many ", "items", "item" ],
			["It's a hot ", "item", "items"],

			["The secretary is ", "typing", "typed"],
			["The book was ", "typed", "typing"],

			["Abbreviations typically help ", "simplify", "simplifying"],
			["Refinement processes are ", "simplifying", "simplify"],

			["Scholars often discuss ", "researching", "researches"],
			["The autodidact also ", "researches", "researching"]
			
			
		];
		for (let i = 0; i < test.length; i++) {
			test[i][1] = test[i][2];
			test[i][2] = 0;
			console.log(test[i]);
		}
*/
		
		/* list 1 for N400 trials, 0 bad, 1 good*/
		var N4A = [
			["Whipped cream tastes ", "sweet", 1],
			["Nervous people are ", "anxious", 1],
			["Crowded rooms are ", "itchy", 0],
			["Smelly feet are ", "noisy", 0],
			["The sky is ", "blue", 1],
			["Pandas are often ", "fat", 1],
			["Leaving home is ", "tasty", 0],
			["Potato chips are ", "sad", 0],
			["I rest on ", "weekends", 1],
			["Swamps sometimes have ", "alligators", 1],
			["Grandma broke her ", "mustache", 0],
			["Fred combed his ", "hip", 0],
			["Kenny watered his ", "flowers", 1],
			["Jobs earn people ", "money", 1],
			["Leave the door ", "terrified", 0],
			["Jenny screamed, feeling ", "open", 0],
			["Cliffs can be ", "steep", 1],
			["Their politics were ", "liberal", 1],
			["I own two ", "questions", 0],
			["Reporters ask many ", "houses", 0],
			["The atmosphere felt ", "unwelcoming", 1],
			["Her hair was ", "brown", 1],
			["The sign pointed ", "delicious", 0],
			["Suzanne's casserole tastes ", "left", 0],
			["The researcher was ", "famous", 1],
			["Stop signs are ", "octagonal,", 1],
			["Infants will often ", "pollinate", 0],
			["Worker bees can ", "cry", 0],
			["Vegans dislike exploiting ", "animals", 1],
			["He dislikes cellular ", "telephones", 1],
			["Athletes generally train ", "humorously", 0],
			["Comedy is received ", "dutifully", 0],
			["Alex taught their ", "students", 1],
			["Many pantries contain ", "flour", 1],
			["Respect isn't easily ", "churned", 0],
			["Butter must be ", "earned", 0],
			["The pizza is ", "scrumptious", 1],
			["Most viruses are ", "contagious", 1],
			["Mystics are often ", "improvised", 0],
			["While practicing, actors ", "distrusted", 0],
			["The hunchback glanced ", "longingly", 1],
			["Some trains levitate ", "magnetically", 1],
			["He wore his ", "lake", 0],
			["Pollutants clouded the ", "scarf", 0],
			["Sports cars are ", "decadent", 1],
			["Jeremy's shoulder was ", "dislocated", 1],
			["Spoiled milk smells ", "mathematical", 0],
			["All proofs are ", "putrid", 0],
			["The chair was ", "refurbished", 1],
			["His motion appeared ", "fluid", 1]
		];
		
		/* list 2 for N400 trials */
		var N4B = [
			["Whipped cream tastes ", "anxious", 0],
			["Nervous people are ", "sweet", 0],
			["Crowded rooms are ", "noisy", 1],
			["Smelly feet are ", "itchy", 1],
			["The sky is ", "fat", 0],
			["Pandas are often ", "blue", 0],
			["Leaving home is ", "sad", 1],
			["Potato chips are ", "tasty", 1],
			["I rest on ", "alligators", 0],
			["Swamps sometimes have ", "weekends", 0],
			["Grandma broke her ", "hip", 1],
			["Fred combed his ", "mustache", 1],
			["Kenny watered his ", "money", 0],
			["Jobs earn people ", "flowers", 0],
			["Leave the door ", "open", 1],
			["Jenny screamed, feeling ", "terrified", 1],
			["Cliffs can be ", "liberal", 0],
			["Their politics were ", "steep", 0],
			["I own two ", "houses", 1],
			["Reporters ask many ", "questions", 1],
			["The atmosphere felt ", "brown", 0],
			["Her hair was ", "unwelcoming", 0],
			["The sign pointed ", "left", 1],
			["Suzanne's casserole tastes ", "delicious", 1],
			["The researcher was ", "octagonal", 0],
			["Stop signs are ", "famous", 0],
			["Infants will often ", "cry", 1],
			["Worker bees can ", "pollinate", 1],
			["Vegans dislike exploiting ", "telephones", 0],
			["He dislikes cellular ", "animals", 0],
			["Athletes generally train ", "dutifully", 1],
			["Comedy is received ", "humorously", 1],
			["Alex taught their ", "flour", 0],
			["Many pantries contain ", "students", 0],
			["Respect isn't easily ", "earned", 1],
			["Butter must be ", "churned", 1],
			["The pizza is ", "contagious", 0],
			["Most viruses are ", "scrumptious", 0],
			["Mystics are often ", "distrusted", 1],
			["While practicing, actors ", "improvised", 1],
			["The hunchback glanced ", "magnetically", 0],
			["Some trains levitate ", "longingly", 0],
			["He wore his ", "scarf", 1],
			["Pollutants clouded the ", "lake", 1],
			["Sports cars are ", "dislocated", 0],
			["Jeremy's shoulder was ", "decadent", 0],
			["Spoiled milk smells ", "putrid", 1],
			["All proofs are ", "mathematical", 1],
			["The chair was ", "fluid", 0],
			["His motion appeared ", "refurbished", 0]
		];
		
		/* make sure both lists are same length */
		console.log("N4A Length is ", N4A.length);
		console.log("N4B Length is ", N4B.length);
		
		/* list 1 for P600 trials */
		var P6A = [
			["The dogs are ", "barking", 1],
			["My dog doesn't ", "bark", 1],
			["Little children should ", "playing", 0],
			["Your brother is ", "play", 0],
			["Fred dropped two ", "books", 1],
			["She took a ", "book", 1],
			["I purchased three ", "ticket", 0],
			["There remained one ", "tickets", 0],
			["Don't forget to ", "smile", 1],
			["The boys were ", "smiling", 1],
			["Herbert listened while ", "ran", 0],
			["Sputtering, the engine ", "running", 0],
			["Bakeries don't sell ", "vehicles", 1],
			["That's an electric ", "vehicle", 1],
			["There's an energy ", "shortages", 0],
			["Bookkeepers noticed supply ", "shortage", 0],
			["The miscreants had ", "loitered", 1],
			["This hotel forbade ", "loitering", 1],
			["They all brought ", "pencil", 0],
			["Sue borrowed a ", "pencils", 0]
		];
		
		/* list 2 for P600 trials */
		var P6B = [
			["The dogs are ", "bark", 0],
			["My dog doesn't ", "barking", 0],
			["Little children should ", "play", 1],
			["Your brother is ", "playing", 1],
			["Fred dropped two ", "book", 0],
			["She took a ", "books", 0],
			["I purchased three ", "tickets", 1],
			["There remained one ", "ticket", 1],
			["Don't forget to ", "smiling", 0],
			["The boys were ", "smile", 0],
			["Herbert listened while ", "running", 1],
			["Sputtering, the engine ", "ran", 1],
			["Bakeries don't sell ", "vehicle", 0],
			["That's an electric ", "vehicles", 0],
			["There's an energy ", "shortage", 1],
			["Bookkeepers noticed supply ", "shortages", 1],
			["The miscreants had ", "loitering", 0],
			["This hotel forbade ", "loitered", 0],
			["They all brought ", "pencils", 1],
			["Sue borrowed a ", "pencil", 1]
		];
		
		/* make sure both lists are same length */
		console.log("P6A Length is ", P6A.length);
		console.log("P6B Length is ", P6B.length);
	  
		/* initialize jsPsych */
		const jsPsych = initJsPsych({ on_finish: function() { jsPsych.data.displayData(); } });
		
		/* create timeline */
	    var timeline = [];
		
		/* collect subject ID */
		var subject_id = {
      		type: jsPsychSurveyText,
    		questions: [{
          		prompt: `<p>Welcome to the ERP experiment for CogSci 213, Fall 2022.</p>
				<p>Please enter the subject ID as a two digit number, e.g., 05</p>`,
        	},],
      	  	data: {
        		task: "subject_id",
      	  	},
    	};
		
		/* fixation cross */
		var fixation = {
		  type: jsPsychHtmlKeyboardResponse,
		  stimulus: '<div style="font-size:60px;">+</div>',
		  choices: "NO_KEYS",
		  trial_duration: 1000,
      	  data: {
        		task: "fixation",
      	  },
		};
		
		/* instructions */
		var instructions = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			Please look at the fixation cross in the middle of the screen when it appears.
			</p>
			<p>
			Four-word sentences will appear word-by-word in the middle of the screen.
			</p>
			<p>
			Your task is to determine whether the sentence is "okay" or not.
			</p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* practice instructions */
		var practice_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			Remember, you will see four-word sentences one word at a time, and your task is to determine whether the four-word sentence is "okay" or not.
			</p>
			<p>
			Example 1: "Cats have four legs." is okay, "Cats have four dolphins." is not okay.
			</p>
			<p>
			Example 2: "The big cat sleeps." is okay, "The big cat sleeping." is not okay.
			</p>
			<p> <b> When the question "Is the sentence okay?" appears,</b> press F for okay or J for not okay. </p>
			</p>
			<p> Please do not move your head or blink while the sentence is being displayed. You may blink or move when the question is on screen. </p>
			<p>
			You will now do a few practice trials.
			</p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* keeps track of whether the practice trials have been answered correctly */
		var loop = false;
		
		/* practice loop instructions */
		var practice_loop_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			You answered one of the practice trials incorrectly. Let's try again!
			</p>
			<p> <b> When the question "Is the sentence okay?" appears,</b> press F for okay or J for not okay. </p>
			</p>
			<p> Please do not move your head or blink while the sentence is being displayed. You may blink or move when the question is on screen. </p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000,
		};
		
		/* conditional timeline for practice loop instructions */
		var if_node_ins = {
			timeline: [practice_loop_ins],
			conditional_function: function(){
				//console.log("running practice_loop_ins, loop is " + loop); //DEBUG
				if (loop) {
					loop = false; //reset loop variable, else we repeat practice trials forever
					return true;
				} else {
					return false;
				}
			}
		}
		
		/* pre-trial instructions */
		var trial_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:600px;">
			<p>
			You will now begin the main experiment.
			</p>
			<p> <b> When the question "Is the sentence okay?" appears,</b> press F for okay or J for not okay. </p>
			<p> Please do not move your head or blink while the sentence is being displayed. You may blink or move when the question is on screen. </p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* debrief */
		var debrief_block = {
		  	type: jsPsychHtmlKeyboardResponse,
		  	stimulus: function() {

		   	 	var trials = jsPsych.data.get().filter({task: 'response'});
		    	var correct_trials = trials.filter({correct: true});
		    	var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
		    	var rt = Math.round(correct_trials.select('rt').mean());

		    	return `<p>You responded correctly on ${accuracy}% of the trials.</p>
		    	  <p>Your average response time was ${rt}ms.</p>
		    	  <p>Press any key to complete the experiment. Thank you!</p>`;

		  	},
		  	on_load: () => {
				var local_data = jsPsych.data.getDataByTimelineNode('0.0-0.0');
				var id = local_data.trials[0].response.Q0;
				//console.log(id);
		  		jsPsych.data.get().localSave('csv',`${id}.csv`);
			},
		};
		
		/* array of sentences for practice */
		var practice_stimuli = [
			{stimulus: "Tom runs very fast.", normal: true, ERP_type: "N4"},
			{stimulus: "Tom runs very hamburger.", normal: false, ERP_type: "N4"},
			{stimulus: "Humans eat to survive.", normal: true, ERP_type: "P6"},
			{stimulus: "Humans eat to surviving.", normal: false, ERP_type: "P6"}
		];
		
		/* practice trial */
		var practice_trial = {
		  	type: JsPsychERPSentence,
		  	stimulus: jsPsych.timelineVariable('stimulus'),
			normal: jsPsych.timelineVariable('normal'),
		  	index: 4,
			choices: ['f', 'j'],
			normal_choice: ['f'],
			delay: 500,
			ERP_type: jsPsych.timelineVariable('ERP_type'),
			on_finish: function(data) {
				if (!data.correct) {
					loop = true;
				}
			}
		}
		
		/* block of practice trials */
		var practice_loop = {
			timeline: [if_node_ins, fixation, practice_trial],
			timeline_variables: practice_stimuli,
			randomize_order: true,
			loop_function: function(data) {
				if (loop) {
					return true;
				} else {
					return false;
				}
			}
		}
		
		/* array of sentences to display */
		var sentence_stimuli = [];
		
		/* fill the sentence_stimuli array */
		var N4 = Math.random() < 0.5 ? N4A : N4B;
		var P6 = Math.random() < 0.5 ? P6A : P6B;
		console.log("using N4A? ", N4 === N4A);
		console.log("using P6A? ", P6 === P6A);
		
		for (let i = 0; i < N4.length; i++) {
			sentence_stimuli.push({
				stimulus: N4[i][0]+N4[i][1]+".",
				normal: Boolean(N4[i][2]),
				ERP_type: "N4"
			});
		}
		for (let i = 0; i < P6.length; i++) {
			sentence_stimuli.push({
				stimulus: P6[i][0]+P6[i][1]+".",
				normal: Boolean(P6[i][2]),
				ERP_type: "P6"
			});
		}
		
		/* unused code to fill sentence_stimuli array with completely randomized sentences */
/*		for (let i = 0; i < N4.length; i++) { //N400
			let j = Math.floor(Math.random() * 2) + 1;
			sentence_stimuli.push({
				stimulus: N4[i][0]+N4[i][j]+".", 
				normal: Boolean(j == 1),
				ERP_type: "N4"});
		}
		for (let i = 0; i < P6.length; i++) { //P600
			let j = Math.floor(Math.random() * 2) + 1;
			sentence_stimuli.push({
				stimulus: P6[i][0]+P6[i][j]+".", 
				normal: Boolean(j == 1),
				ERP_type: "P6"});
		}
*/
		
		/* sentence display trial */
		var sentence_trial = {
		  	type: JsPsychERPSentence,
		  	stimulus: jsPsych.timelineVariable('stimulus'),
			normal: jsPsych.timelineVariable('normal'),
		  	index: 4,
			choices: ['f', 'j'],
			normal_choice: ['f'],
			delay: 500,
			ERP_type: jsPsych.timelineVariable('ERP_type'),
      	  	data: {
        		task: "response",
      	  	},
		}
		
		/* block of sentence trials */
		var sentence_block = {
			timeline: [fixation, sentence_trial],
			timeline_variables: sentence_stimuli,
			randomize_order: true
		}
		
		/* set up timeline */
		timeline = [
		    subject_id,
		    instructions,
			practice_ins,
			practice_loop,
			trial_ins,
			sentence_block,
			debrief_block
		];
		
		/* start the experiment */
		jsPsych.run(timeline);
		
	</script>
</html>
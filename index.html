<!DOCTYPE html>
<html>
	<head>
		<title>F22 213 ERP Experiment</title>
		<script src="JSPsych/jspsych@7.3.0"></script>
		<script src="JSPsych/plugin-html-keyboard-response@1.1.2"></script>
	    <script src="JSPsych/plugin-survey-text@1.1.0"></script>
		<script src="erp-sentence/index.js"></script>
		<link href="JSPsych/jspsych.css" rel="stylesheet" type="text/css" />
	</head>
	<body></body>
	<script>
		/* sentence options for N400 trials */
		var N4 = [
			["Whipped cream tastes ", "sweet", "anxious"],
			["Crowded rooms are ", "noisy", "itchy"],
			["The sky is ", "blue", "fat"],
			["Nervous people are ", "anxious", "sweet"],
			["Smelly feet are ", "itchy", "noisy"],
			["Pandas are often ", "fat", "blue"]
		];
		
		/* sentence options for P600 trials */
		var P6 = [
			["The dogs are ", "barking", "bark"],
			["Little children should ", "play", "playing"],
			["Fred dropped two ", "books", "book"],
			["My dog doesn't ", "bark", "barking"],
			["Your brother is ", "playing", "play"],
			["She took a ", "book", "books"]
		];
	  
		/* initialize jsPsych */
		const jsPsych = initJsPsych({ on_finish: function() { jsPsych.data.displayData(); } });
		
		/* create timeline */
	    var timeline = [];
		
		/* collect subject ID */
		var subject_id = {
      		type: jsPsychSurveyText,
    		questions: [{
          		prompt: `<p>Welcome to the ERP experiment for CogSci 213, Fall 2022.</p>
				<p>Please enter the subject ID as a two digit number, e.g., 05</p>`,
        	},],
      	  	data: {
        		task: "subject_id",
      	  	},
    	};
		
		/* fixation cross */
		var fixation = {
		  type: jsPsychHtmlKeyboardResponse,
		  stimulus: '<div style="font-size:60px;">+</div>',
		  choices: "NO_KEYS",
		  trial_duration: 1000,
      	  data: {
        		task: "fixation",
      	  },
		};
		
		/* instructions */
		var instructions = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			Please look at the fixation cross in the middle of the screen when it appears.
			</p>
			<p>
			Four-word sentences will appear word-by-word in the middle of the screen.
			</p>
			<p>
			Your task is to determine whether the sentence is "okay" or not.
			</p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* practice instructions */
		var practice_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			You will now do a few practice trials.
			</p>
			<p>
			Remember, you will see four-word sentences one word at a time, and your task is to determine whether the four-word sentence is "okay" or not.
			</p>
			<p>
			Example 1: "Cats have four legs." is okay, "Cats have four dolphins." is not okay.
			</p>
			<p>
			Example 2: "The big cat sleeps." is okay, "The big cat sleeping." is not okay.
			</p>
			<p> <em>When the last word in the sentence appears</em>, press F for okay or J for not okay. </p>
			<p> For the sentences above, you would press "F" when you see "legs" and "sleeps", and "J" when you see "dolphins" and "sleeping" 
			</p>
			<p> Please respond as quickly as possible while being accurate. </p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* keeps track of whether the practice trials have been answered correctly */
		var loop = false;
		
		/* practice loop instructions */
		var practice_loop_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:800px;">
			<p>
			You answered one of the practice trials incorrectly. Let's try again!
			</p>
			<p>
			Remember, you will see four-word sentences one word at a time, and your task is to determine whether the four-word sentence is "okay" or not.
			</p>
			<p>
			Example 1: "Cats have four legs." is okay, "Cats have four dolphins." is not okay.
			</p>
			<p>
			Example 2: "The big cat sleeps." is okay, "The big cat sleeping." is not okay.
			</p>
			<p> When the last word in the sentence appears, press F for okay or J for not okay. </p>
			<p> For the sentences above, you would press "F" when you see "legs." or "sleeps.", and "J" when you see "dolphins." or "sleeping."
			</p>
			<p> Please respond as quickly as possible while being accurate. </p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000,
		};
		
		/* conditional timeline for practice loop instructions */
		var if_node_ins = {
			timeline: [practice_loop_ins],
			conditional_function: function(){
				//console.log("running practice_loop_ins, loop is " + loop); //DEBUG
				if (loop) {
					loop = false; //reset loop variable, else we repeat practice trials forever
					return true;
				} else {
					return false;
				}
			}
		}
		
		/* pre-trial instructions */
		var trial_ins = { type: jsPsychHtmlKeyboardResponse, stimulus: 
			`<div style="width:600px;">
			<p>
			You will now begin the main experiment.
			</p>
			<p>
			Remember, your task is to determine whether the four-word sentence is "okay" or not.
			</p>
			<p> When the last word in the sentence appears, press F for okay or J for not okay. </p>
			<p> Please respond as quickly as possible while being accurate. </p>
			<p> Press the spacebar to continue. </p>`,
			choices: [' '],
			post_trial_gap: 1000
		};
		
		/* debrief */
		var debrief_block = {
		  	type: jsPsychHtmlKeyboardResponse,
		  	stimulus: function() {

		   	 	var trials = jsPsych.data.get().filter({task: 'response'});
		    	var correct_trials = trials.filter({correct: true});
		    	var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
		    	var rt = Math.round(correct_trials.select('rt').mean());

		    	return `<p>You responded correctly on ${accuracy}% of the trials.</p>
		    	  <p>Your average response time was ${rt}ms.</p>
		    	  <p>Press any key to complete the experiment. Thank you!</p>`;

		  	},
		  	on_load: () => {
				var local_data = jsPsych.data.getDataByTimelineNode('0.0-0.0');
				var id = local_data.trials[0].response.Q0;
				//console.log(id);
		  		jsPsych.data.get().localSave('csv',`${id}.csv`);
			},
		};
		
		/* array of sentences for practice */
		var practice_stimuli = [
			{stimulus: "Tom runs very fast.", normal: true, ERP_type: "N4"},
			{stimulus: "Tom runs very hamburger.", normal: false, ERP_type: "N4"},
			{stimulus: "Humans eat to survive.", normal: true, ERP_type: "P6"},
			{stimulus: "Humans eat to surviving.", normal: false, ERP_type: "P6"}
		];
		
		/* practice trial */
		var practice_trial = {
		  	type: JsPsychERPSentence,
		  	stimulus: jsPsych.timelineVariable('stimulus'),
			normal: jsPsych.timelineVariable('normal'),
		  	index: 4,
			choices: ['f', 'j'],
			normal_choice: ['f'],
			delay: 500,
			ERP_type: jsPsych.timelineVariable('ERP_type'),
			on_finish: function(data) {
				if (!data.correct) {
					loop = true;
				}
			}
		}
		
		/* block of practice trials */
		var practice_loop = {
			timeline: [if_node_ins, fixation, practice_trial],
			timeline_variables: practice_stimuli,
			randomize_order: true,
			loop_function: function(data) {
				if (loop) {
					return true;
				} else {
					return false;
				}
			}
		}
		
		/* array of sentences to display */
		var sentence_stimuli = [];
		
		/* fill the sentence_stimuli array with randomized sentences */
		for (let i = 0; i < N4.length; i++) { //N400
			let j = Math.floor(Math.random() * 2) + 1;
			sentence_stimuli.push({
				stimulus: N4[i][0]+N4[i][j]+".", 
				normal: Boolean(j == 1),
				ERP_type: "N4"});
		}
		for (let i = 0; i < P6.length; i++) { //P600
			let j = Math.floor(Math.random() * 2) + 1;
			sentence_stimuli.push({
				stimulus: P6[i][0]+P6[i][j]+".", 
				normal: Boolean(j == 1),
				ERP_type: "P6"});
		}
		
		/* sentence display trial */
		var sentence_trial = {
		  	type: JsPsychERPSentence,
		  	stimulus: jsPsych.timelineVariable('stimulus'),
			normal: jsPsych.timelineVariable('normal'),
		  	index: 4,
			choices: ['f', 'j'],
			normal_choice: ['f'],
			delay: 500,
			ERP_type: jsPsych.timelineVariable('ERP_type'),
      	  	data: {
        		task: "response",
      	  	},
		}
		
		/* block of sentence trials */
		var sentence_block = {
			timeline: [fixation, sentence_trial],
			timeline_variables: sentence_stimuli,
			randomize_order: true
		}
		
		/* set up timeline */
		timeline = [
		    subject_id,
		    instructions,
			practice_ins,
			practice_loop,
			trial_ins,
			sentence_block,
			debrief_block
		];
		
		/* start the experiment */
		jsPsych.run(timeline);
		
	</script>
</html>